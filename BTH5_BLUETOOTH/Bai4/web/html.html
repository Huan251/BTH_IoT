<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bi·ªÉu ƒë·ªì Nhi·ªát ƒë·ªô DHT11 Real-time</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background-color: #f4f4f4; }
        #chartContainer 
        {
            width: 90%;
            max-width: 800px; /* Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc bi·ªÉu ƒë·ªì */
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .data-display { margin-bottom: 20px; font-size: 1.2em; }
        .data-display strong { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>üå°Ô∏è Bi·ªÉu ƒë·ªì Nhi·ªát ƒë·ªô DHT11 Real-time</h1>
    <div class="data-display">
        Nhi·ªát ƒë·ªô hi·ªán t·∫°i: <strong id="currentTemp">-</strong> ¬∞C | 
        ƒê·ªô ·∫©m hi·ªán t·∫°i: <strong id="currentHum">-</strong> %RH
    </div>
    
    <div id="chartContainer">
        <canvas id="tempChart"></canvas>
    </div>

    <script>
        // ƒê·ªãa ch·ªâ WebSocket Server c·ªßa Node.js (c·ªïng 8080)
        const WS_SERVER_URL = 'ws://localhost:8080'; 
        const maxDataPoints = 15; // Gi·ªõi h·∫°n 15 ƒëi·ªÉm d·ªØ li·ªáu tr√™n bi·ªÉu ƒë·ªì
        
        // --- KH·ªûI T·∫†O BI·ªÇU ƒê·ªí CHART.JS ---
        const ctx = document.getElementById('tempChart').getContext('2d');
        const tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // D·ªØ li·ªáu tr·ª•c X: Th·ªùi gian
                datasets: [{
                    label: 'Nhi·ªát ƒë·ªô (¬∞C)',
                    data: [], // D·ªØ li·ªáu tr·ª•c Y: Gi√° tr·ªã nhi·ªát ƒë·ªô
                    borderColor: '#e74c3c', // M√†u ƒë·ªè
                    backgroundColor: 'rgba(231, 76, 60, 0.2)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Cho ph√©p t√πy ch·ªânh k√≠ch th∆∞·ªõc
                scales: {
                    y: {
                        title: { display: true, text: 'Nhi·ªát ƒë·ªô (¬∞C)' },
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        });

        // --- K·∫æT N·ªêI V√Ä X·ª¨ L√ù D·ªÆ LI·ªÜU WEBSOCKET ---
        const ws = new WebSocket(WS_SERVER_URL); 

        ws.onopen = () => {
            console.log('‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi WebSocket Server.');
        };

        ws.onmessage = (event) => {
            try {
                // D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c l√† JSON string t·ª´ Node.js
                const data = JSON.parse(event.data); 
                
                // C·∫≠p nh·∫≠t c√°c Label hi·ªÉn th·ªã
                document.getElementById('currentTemp').innerText = data.temp.toFixed(1);
                document.getElementById('currentHum').innerText = data.hum.toFixed(1);

                // Th√™m d·ªØ li·ªáu v√†o bi·ªÉu ƒë·ªì
                updateChart(data.time, data.temp);

            } catch (error) {
                console.error("‚ùå L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu WebSocket:", error);
            }
        };

        ws.onclose = () => {
            console.log('üõë M·∫•t k·∫øt n·ªëi t·ªõi WebSocket Server.');
        };

        ws.onerror = (error) => {
            console.error('L·ªói WebSocket:', error);
        };
        
        // --- H√ÄM C·∫¨P NH·∫¨T BI·ªÇU ƒê·ªí ---
        function updateChart(time, temperature) {
            // Th√™m gi√° tr·ªã m·ªõi
            tempChart.data.labels.push(time);
            tempChart.data.datasets[0].data.push(temperature);
            
            // Gi·ªõi h·∫°n s·ªë ƒëi·ªÉm d·ªØ li·ªáu ƒë·ªÉ bi·ªÉu ƒë·ªì kh√¥ng qu√° d√†i
            if (tempChart.data.labels.length > maxDataPoints) {
                tempChart.data.labels.shift(); // X√≥a gi√° tr·ªã c≈© nh·∫•t (tr·ª•c X)
                tempChart.data.datasets[0].data.shift(); // X√≥a gi√° tr·ªã c≈© nh·∫•t (tr·ª•c Y)
            }
            
            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
            tempChart.update();
        }
    </script>
</body>
</html>